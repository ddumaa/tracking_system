# tracking_system
# Parcel tracking system
Belpost and Evropost

## Миграция статистики

Начиная с версии `V10` в таблицах статистики добавлены уникальные ограничения.
Перед применением ограничений выполняется агрегация дубликатов, поэтому на существующих инсталляциях достаточно запустить стандартные Flyway-миграции.
Скрипт `V10__deduplicate_statistics_and_add_constraints.sql` удалит повторяющиеся записи и создаст уникальные ключи.

## Конфигурация OpenCV

В файле `application.properties` добавлено свойство `opencv.lib.path`, которое определяет путь к нативной библиотеке OpenCV. По умолчанию используется `/usr/lib/jni/libopencv_java4100.so`.

## Конфигурация Tesseract

Для работы OCR-сервиса в `application.properties` необходимо указать путь к каталогу с данными Tesseract через свойство `tesseract.datapath`. По умолчанию используется `/usr/local/share/tessdata`.

## Компиляция CSS

Для генерации стилей используется Sass, исходный SCSS размещён в каталоге `src/main/resources/assets/scss`.

- `npm run build:css` — выполняет разовую компиляцию файла `main.scss` и создаёт `src/main/resources/static/css/style.css`.
- `npm run watch:css` — отслеживает изменения SCSS и автоматически обновляет тот же CSS-файл.

Скомпилированный `style.css` располагается в `src/main/resources/static/css` и подключается приложением при запуске.

## Автообновление треков

Функция автообновления использует лимит `maxTrackUpdates` тарифного плана. Количество обновлений в сутки не может превышать этот показатель.

## Настройка Telegram-ботов

Пользователь может подключить собственного Telegram-бота к каждому магазину.
В настройках профиля откройте блок магазина и в разделе Telegram укажите токен
нового бота. Токен проверяется сервисом `TelegramBotValidationService`. После
успешной проверки информация сохраняется в `StoreTelegramSettings` в полях
`botToken` и `botUsername`. При отсутствии токена используется системный бот
приложения.

Связи между покупателями и Telegram-чатами хранятся в таблице
`CustomerTelegramLink`. Каждая запись содержит идентификатор чата, магазин,
номер телефона покупателя, а также флаги `telegramConfirmed` и
`notificationsEnabled`.

Отправкой уведомлений занимается `TelegramNotificationService`. Сервис ищет
подходящую запись `CustomerTelegramLink`, формирует текст по шаблонам из
`StoreTelegramSettings` и отправляет сообщение через системного или
пользовательского бота. Уведомления отправляются только если чат подтверждён и
не отключены уведомления.

