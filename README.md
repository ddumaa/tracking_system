# Parcel tracking system
Belpost and Evropost

## Компиляция CSS

Для генерации стилей используется Sass, исходный SCSS размещён в каталоге `src/main/resources/assets/scss`.

- `npm run build:css` — выполняет разовую компиляцию файла `main.scss` и создаёт `src/main/resources/static/css/style.css`.
- `npm run watch:css` — отслеживает изменения SCSS и автоматически обновляет тот же CSS-файл.

Скомпилированный `style.css` располагается в `src/main/resources/static/css` и подключается приложением при запуске.

## Конфигурация ChromeDriver

Selenium Manager автоматически определяет и скачивает совместимый

ChromeDriver, поэтому указывать путь к драйверу обычно не требуется.
При необходимости использования локального бинарника задайте свойство
`webdriver.chrome.driver` в `application.properties` или переменную окружения
`WEBDRIVER_CHROME_DRIVER`.
Если файл существует и доступен для выполнения, Selenium Manager
будет отключён, а указанный драйвер использован.

```java
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;

WebDriver driver = new ChromeDriver();
```

В Docker путь к бинарнику также можно передать через переменную окружения
`WEBDRIVER_CHROME_DRIVER` или `CHROMEDRIVER_PATH`.

### Отключение аналитики Selenium Manager

Переменная окружения `SE_MANAGER_ANALYTICS=false` (или `0`) отключает отправку
статистики Selenium Manager и уменьшает шум в логах. Она уже прописана в
`Dockerfile`, но при запуске вне контейнера её можно задать вручную.

### Сборка Docker-образа

По умолчанию Dockerfile собирает образ с Chrome версии `140.0.7339.82`. При необходимости указать другую версию передайте её через параметр `--build-arg`:

```bash
docker build --build-arg CHROME_VERSION=140.0.7339.82 .
```

Если используется `docker compose`, аргумент можно задать аналогично:

```bash
docker compose build --build-arg CHROME_VERSION=140.0.7339.82
```

## Автообновление треков

Функция автообновления использует лимит `maxTrackUpdates` тарифного плана. Количество обновлений в сутки не может превышать этот показатель.

## Версия приложения

Актуальная версия задаётся в `application.properties` свойством `application.version`.
Получить её можно через REST-эндпоинт `/app/version`, который возвращает JSON
следующего вида:

```json
{ "version": "0.7.1" }
```

## Очередь Белпочты

 - **Планирование.** Метод `processQueue()` помечен
   `@Scheduled(fixedDelayString = "${belpost.queue.delay-ms:100}")`, что
   обеспечивает практически непрерывную обработку треков. При ошибке Selenium
   обработка приостанавливается на минуту.
 - **Параметры.** Значение задержки задаётся параметром
   `belpost.queue.delay-ms` (по умолчанию `100` мс) и может быть изменено в
   `application.properties`.

Обработка треков Европочты начинается сразу и не помещается в очередь.
Ожидание рассчитывается только для треков Белпочты.

При постановке треков Белпочты в очередь сервис вычисляет примерное время до
старта их обработки. Метод `estimateWaitTime(userId)` возвращает длительность
ожидания исходя из позиции пользователя в очереди. Если партия содержит
треки только Европочты, уведомление о таком ожидании не отправляется. Когда
ожидание есть, во всплывающем уведомлении и в событии `track-processing-started`
уточняется, что речь идёт именно о треках Белпочты.

После постановки треков в очередь пользователь получает отдельное уведомление
о факте добавления и количестве треков, чтобы понимать, какие действия
происходят.

### Примеры событий WebSocket

```json
// belpost/batch-started/{userId}
{ "batchId": 1, "totalCount": 5 }

// belpost/track-processed/{userId}
{ "batchId": 1, "trackNumber": "RR123", "processed": 1, "success": 1, "failed": 0 }

// belpost/batch-finished/{userId}
{ "batchId": 1, "processed": 5, "success": 4, "failed": 1 }
```

После загрузки файла с треками пользователь может следить за прогрессом
в веб-интерфейсе: уведомления по WebSocket отображаются в правом верхнем углу
страницы и обновляют таблицу по мере завершения обработки.

## Интервал обновления прогресса

Сервис `ProgressAggregatorService` отправляет клиентам сообщения о ходе обработки треков.
Чтобы не перегружать браузер избыточными событиями, частота обновлений регулируется
свойством `progress.update-interval-ms`. Оно задаёт минимальную задержку между
отправками прогресса в миллисекундах. Значение по умолчанию — `250` мс.

При необходимости параметр можно переопределить в `application.properties`:

```properties
# пример увеличенного интервала между обновлениями до 500 мс
progress.update-interval-ms=500
```

## Проверка и нормализация треков

Перед постановкой в очередь каждый трек проходит валидацию в сервисе
`TrackMetaValidator`. Номера нормализуются, проверяются на принадлежность
почтовым службам и уникальность. Строки, не прошедшие проверку, помещаются
в список `InvalidTrack` и возвращаются вместе с корректными записями в объекте
`TrackMetaValidationResult`. Если превышены лимиты загрузки или сохранения,
в поле `limitExceededMessage` передаётся текст предупреждения.

## Кэширование результатов отслеживания

Результаты запросов и списки некорректных треков хранятся в памяти.
До первого просмотра пользователем записи не удаляются,
после просмотра вступает в силу TTL.
Величина TTL настраивается через панель администрирования и по умолчанию
соответствует свойству `tracking.result-cache.expiration-ms`.

## Тестирование

Для запуска модульных и интеграционных тестов выполните:

```bash
mvn test
```

Тесты используют встроенный брокер WebSocket и не требуют дополнительной настройки.

## Оптимизация базы данных

Новая миграция `V5__index_parcels_timestamp.sql` создаёт индекс `idx_parcels_timestamp`
для таблицы `tb_track_parcels`. Индекс ускоряет поиск и сортировку записей по дате.

## Content Security Policy

Встроенные обработчики событий постепенно заменяются внешними скриптами для соблюдения CSP. Кнопка копирования ссылки на Telegram-бота теперь инициализируется функцией `initTelegramLinkCopy()` в `static/js/app.js`.

## Жизненный цикл возвратов и обменов

Модальное окно трека отображает этапы обслуживания заказа, объединяя исходную посылку, заявку на возврат и возможный обмен:

- **Отправление магазина.** Блок отражает исходную посылку и использует номер трека как контекст этапа. Состояние рассчитывается на стороне сервиса `TrackViewService` на основе текущего статуса записи. Новые поля `trackNumber` и `trackContext` в `TrackLifecycleStageDto` делают подпись понятной менеджерам и покупателям.【F:src/main/java/com/project/tracking_system/dto/TrackLifecycleStageDto†L5-L23】【F:src/main/java/com/project/tracking_system/service/track/TrackViewService.java†L83-L123】
- **Возврат от покупателя.** Этап активируется после создания заявки и показывает обратный трек, который клиент добавляет через бота или веб-интерфейс. Формирование описания выполняет `buildLifecycle`, определяя состояние по факту старта обратной отправки и моменту регистрации заявки.【F:src/main/java/com/project/tracking_system/service/track/TrackViewService.java†L124-L157】
- **Обработка магазина и обмен.** Когда возврат подтверждён, сервис добавляет этапы приёма возврата и, при необходимости, отправки обменной посылки. Каждая стадия снабжена поясняющим заголовком и номером соответствующего трека, чтобы проследить весь путь без перезагрузки страницы.【F:src/main/java/com/project/tracking_system/service/track/TrackViewService.java†L158-L266】

Фронтенд выводит карточку «Жизненный цикл заказа» в модалке, связывая этапы с кнопками действий и обновляя их после изменения заявки, не требуя полного перезапуска интерфейса.【F:src/main/resources/static/js/track-modal.js†L358-L482】
