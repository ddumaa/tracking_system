<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <title layout:fragment="title">Профиль</title>
</head>

<main layout:fragment="content">
    <div class="container-xl">
        <div class="row">

            <!-- Плавающая кнопка вызова меню (мобильная версия) -->
            <button class="menu-toggle d-md-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#settingsSidebar" title="Меню настроек">
                <i class="bi bi-gear" title="Меню"></i>
            </button>

            <!-- Offcanvas боковая панель -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="settingsSidebar"
                 aria-labelledby="settingsSidebarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="settingsSidebarLabel">Меню</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="nav flex-column nav-pills profile-tab-menu" id="v-pills-tab-offcanvas" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active d-flex align-items-center" id="v-pills-home-tab-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-home" role="tab">
                            <i class="bi bi-person me-2" title="Об аккаунте"></i> Об аккаунте
                        </a>
                        <a class="nav-link d-flex align-items-center" id="stores-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-stores" role="tab">
                            <i class="bi bi-shop me-2" title="Мои магазины"></i> Мои магазины
                        </a>
                        <a class="nav-link d-flex align-items-center" id="notifications-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-notifications" role="tab">
                            <i class="bi bi-bell me-2" title="Уведомления (Telegram)"></i> Уведомления (Telegram)
                        </a>
                        <a class="nav-link d-flex align-items-center" id="automation-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-automation" role="tab">
                            <i class="bi bi-lightning-charge me-2" title="Функции и автоматизация"></i> Функции и автоматизация
                        </a>
                        <a class="nav-link d-flex align-items-center" id="plan-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-plan" role="tab">
                            <i class="bi bi-speedometer2 me-2" title="Тариф и лимиты"></i> Тариф и лимиты
                        </a>
                        <a class="nav-link d-flex align-items-center" id="integrations-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-integrations" role="tab">
                            <i class="bi bi-link-45deg me-2" title="Интеграции (API)"></i> Интеграции (API)
                        </a>
                        <a class="nav-link d-flex align-items-center" id="security-settings-link-offcanvas" data-bs-toggle="pill"
                           href="#v-pills-security" role="tab">
                            <i class="bi bi-shield-lock me-2" title="Безопасность"></i> Безопасность
                        </a>
                    </div>
                </div>
            </div>

            <!-- Боковое меню (для ПК и планшетов) -->
            <div class="col-lg-3 col-md-4 d-none d-md-block">
                <div class="card shadow-sm p-4 rounded-4 sticky-sidebar">
                    <h5 class="mb-3 text-center">Меню</h5>
                    <div class="nav flex-column nav-pills profile-tab-menu" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active d-flex align-items-center" id="v-pills-home-tab" data-bs-toggle="pill"
                           href="#v-pills-home" role="tab">
                            <i class="bi bi-person me-2" title="Об аккаунте"></i> Об аккаунте
                        </a>
                        <a class="nav-link d-flex align-items-center" id="stores-settings-link" data-bs-toggle="pill"
                           href="#v-pills-stores" role="tab">
                            <i class="bi bi-shop me-2" title="Мои магазины"></i> Мои магазины
                        </a>
                        <a class="nav-link d-flex align-items-center" id="notifications-settings-link" data-bs-toggle="pill"
                           href="#v-pills-notifications" role="tab">
                            <i class="bi bi-bell me-2" title="Уведомления (Telegram)"></i> Уведомления (Telegram)
                        </a>
                        <a class="nav-link d-flex align-items-center" id="automation-settings-link" data-bs-toggle="pill"
                           href="#v-pills-automation" role="tab">
                            <i class="bi bi-lightning-charge me-2" title="Функции и автоматизация"></i> Функции и автоматизация
                        </a>
                        <a class="nav-link d-flex align-items-center" id="plan-settings-link" data-bs-toggle="pill"
                           href="#v-pills-plan" role="tab">
                            <i class="bi bi-speedometer2 me-2" title="Тариф и лимиты"></i> Тариф и лимиты
                        </a>
                        <a class="nav-link d-flex align-items-center" id="integrations-settings-link" data-bs-toggle="pill"
                           href="#v-pills-integrations" role="tab">
                            <i class="bi bi-link-45deg me-2" title="Интеграции (API)"></i> Интеграции (API)
                        </a>
                        <a class="nav-link d-flex align-items-center" id="security-settings-link" data-bs-toggle="pill"
                           href="#v-pills-security" role="tab">
                            <i class="bi bi-shield-lock me-2" title="Безопасность"></i> Безопасность
                        </a>
                    </div>
                </div>
            </div>

            <!-- Контент вкладок -->
            <div class="col-lg-9 col-md-8 tab-content" id="v-pills-tabContent">

<div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <h5 class="mb-3">Об аккаунте</h5>
        <hr class="my-3">
        <div class="row mb-2">
            <div class="col-sm-4 text-muted">Email</div>
            <div class="col-sm-8" th:text="${userProfile.email}"></div>
        </div>
        <div class="row mb-2">
            <div class="col-sm-4 text-muted">Тариф</div>
            <div class="col-sm-8">
                <span th:class="'badge ' + (${userProfile.subscriptionCode == 'PREMIUM'} ? 'bg-success' : 'bg-secondary')"
                      th:text="${userProfile.subscriptionDisplayName}"></span>
            </div>
        </div>
        <div class="row mb-2" th:if="${userProfile.subscriptionEndDate != null}">
            <div class="col-sm-4 text-muted">Оплачено до</div>
            <div class="col-sm-8" th:text="${userProfile.subscriptionEndDate}"></div>
        </div>
        <div class="row mb-2">
            <div class="col-sm-4 text-muted">Часовой пояс</div>
            <div class="col-sm-8" th:text="${userProfile.timezone}"></div>
        </div>
    </div>
</div>

<div class="tab-pane fade" id="v-pills-stores" role="tabpanel" aria-labelledby="stores-settings-link">

                    <!-- Контейнер для уведомлений -->
                    <div id="storeNotificationContainer"></div>

                    <div class="card p-3 shadow-sm rounded-4 mb-4">

                        <h5 class="mb-3">
                            Мои магазины
                            <span class="text-muted" id="store-limit" th:text="${storeLimit}"></span>
                        </h5>

                        <form id="store-settings-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Название магазина</th>
                                    <th>Действия</th>
                                </tr>
                                </thead>
                                <tbody id="storeTableBody">
                                <!-- Заполняется через JS -->
                                </tbody>
                            </table>

                            <button type="button" class="btn btn-primary mt-3" id="addStoreBtn">Добавить магазин
                            </button>
                        </form>
                    </div>

                    <div class="card p-3 shadow-sm rounded-4 mb-4">
                        <div class="mt-4" id="analytics-management">
                            <h5 class="mb-3">
                                Управление аналитикой
                            </h5>
                            <div id="storeAnalyticsButtons" class="d-flex flex-wrap gap-2 mb-3">
                                <!-- Кнопки — через JS --></div>
                            <button type="button" class="btn btn-danger d-flex align-items-center"
                                    id="resetAllAnalyticsBtn">
                                <i class="bi bi-trash me-2"></i>
                                Удалить всю аналитику
                            </button>
                        </div>
                    </div>

                </div>

<div class="tab-pane fade" id="v-pills-notifications" role="tabpanel" aria-labelledby="notifications-settings-link">
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <h5 class="mb-3">Уведомления (Telegram)</h5>
        <form id="telegram-notifications-form" class="mt-2">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="form-check form-switch">
                <!-- При недоступной функции переключатель всегда выключен -->
                <input class="form-check-input" type="checkbox" id="telegramNotificationsToggle"
                       th:checked="${planDetails.allowTelegramNotifications and userSettingsDTO.telegramNotificationsEnabled}"
                       th:disabled="${!planDetails.allowTelegramNotifications}">
                <label class="form-check-label" for="telegramNotificationsToggle">Получать уведомления о статусах посылок</label>
            </div>
            <p class="form-text text-danger ms-4" th:if="${!planDetails.allowTelegramNotifications}">
                Функция доступна в тарифе "Команда" и выше
            </p>
        </form>
    </div>
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <div id="telegram-management" class="mt-4">
            <h5 class="mb-3">Настройки Telegram</h5>
            <p class="form-text text-danger" th:if="${!planDetails.allowTelegramNotifications}">
                Функция доступна в тарифе "Команда" и выше
            </p>
            <p class="text-muted mb-3">
                Настройки уведомлений для покупателей в Telegram. Если включено, покупатели будут
                получать автоматические уведомления о статусах посылок (например, «отправлена», «прибыла
                в пункт выдачи» и др.).
            </p>
            <th:block th:each="store, iter : ${stores}">
                <div th:replace="~{profile :: telegramStoreBlock(store=${store}, first=${iter.first})}"></div>
            </th:block>
        </div>
    </div>
</div>

<div class="tab-pane fade" id="v-pills-automation" role="tabpanel" aria-labelledby="automation-settings-link">
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <h5 class="mb-3">Функции и автоматизация</h5>
        <form id="auto-update-form" class="mt-2">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoUpdateToggle"
                       th:checked="${planDetails.allowAutoUpdate ? userProfile.autoUpdateEnabled : false}"
                       th:disabled="${!planDetails.allowAutoUpdate}">
                <label class="form-check-label" for="autoUpdateToggle">Автообновление треков</label>
            </div>
            <p class="form-text text-danger ms-4" th:if="${!planDetails.allowAutoUpdate}">
                Функция доступна в тарифе "Бизнес" и выше
            </p>
            <p class="form-text ms-4">Автообновления расходуют дневной лимит обновлений.</p>
        </form>
        <form id="bulk-button-form" class="mt-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showBulkUpdateButton"
                       th:checked="${planDetails.allowBulkUpdate ? userSettingsDTO.showBulkUpdateButton : false}"
                       th:disabled="${!planDetails.allowBulkUpdate}">
                <label class="form-check-label" for="showBulkUpdateButton">Показывать кнопку массового обновления</label>
            </div>
            <p class="form-text text-danger ms-4" th:if="${!planDetails.allowBulkUpdate}">
                Функция доступна в тарифе "Бизнес" и выше
            </p>
        </form>
    </div>
</div>

<div class="tab-pane fade card p-3 shadow-sm rounded-4 mb-4" id="v-pills-plan" role="tabpanel" aria-labelledby="plan-settings-link">
    <h5 class="mb-3">Тариф и лимиты</h5>
    <p class="fw-semibold mb-2">Текущий тариф:
        <span class="badge bg-primary" th:text="${planDetails.name}"></span>
    </p>
    <ul class="list-unstyled">
        <li>📥 Треков в файле:
            <strong th:text="${planDetails.maxTracksPerFile != null ? planDetails.maxTracksPerFile : 'Без лимита'}"></strong>
        </li>
        <li>💾 Сохранённых треков:
            <strong th:text="${planDetails.maxSavedTracks != null ? userProfile.savedTracksUsed + '/' + planDetails.maxSavedTracks : userProfile.savedTracksUsed + '/∞'}"></strong>
        </li>
        <li>🔄 Обновлений в день:
            <strong th:text="${planDetails.maxTrackUpdates != null ? userProfile.trackUpdatesUsed + '/' + planDetails.maxTrackUpdates : 'Без лимита'}"></strong>
        </li>
        <li>🏬 Магазинов:
            <strong th:text="${userProfile.storesUsed + '/' + planDetails.maxStores}"></strong>
        </li>
        <li>
            <span th:if="${planDetails.allowBulkUpdate}">✅ Массовое обновление</span>
            <span th:unless="${planDetails.allowBulkUpdate}" class="text-muted">❌ Массовое обновление</span>
        </li>
        <li>
            <span th:if="${planDetails.allowAutoUpdate}">♻️ Автообновление треков</span>
            <span th:unless="${planDetails.allowAutoUpdate}" class="text-muted">❌ Автообновление треков</span>
        </li>
        <li>
            <span th:if="${planDetails.allowTelegramNotifications}">📨 Telegram-уведомления</span>
            <span th:unless="${planDetails.allowTelegramNotifications}" class="text-muted">❌ Telegram-уведомления</span>
        </li>
        <li>
            <span th:if="${planDetails.allowCustomBot}">🤖 Собственный бот</span>
            <span th:unless="${planDetails.allowCustomBot}" class="text-muted">❌ Собственный бот</span>
        </li>
    </ul>
</div>

<div class="tab-pane fade" id="v-pills-integrations" role="tabpanel" aria-labelledby="integrations-settings-link">
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <!-- Контейнер для уведомлений -->
        <div id="evropostNotificationContainer"></div>
        <div id="evropost-content" th:fragment="evropostFragment">
            <h5 class="mb-3">Настройки Европочты</h5>
            <form id="evropost-settings-form" th:action="@{/profile/settings/evropost}" th:object="${evropostCredentialsDTO}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="useCustomCredentials" name="useCustomCredentials" th:field="*{useCustomCredentials}">
                    <label class="form-check-label" for="useCustomCredentials">Подключить API Европочты (договор – бесплатно)</label>
                </div>
                <div id="custom-credentials-fields" class="hidden">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="evropostUsername" name="evropostUsername" th:field="*{evropostUsername}" placeholder="LoginName" autocomplete="off">
                        <label for="evropostUsername">LoginName</label>
                        <div th:errors="*{evropostUsername}" class="text-danger"></div>
                    </div>
                    <div class="form-floating mb-3 position-relative">
                        <input type="password" class="form-control password-input" id="evropostPassword" name="evropostPassword" th:field="*{evropostPassword}" placeholder="Password" autocomplete="off">
                        <label for="evropostPassword">Password</label>
                        <span class="toggle-password" data-target="evropostPassword">
                            <i class="bi bi-eye"></i>
                        </span>
                        <div th:errors="*{evropostPassword}" class="text-danger"></div>
                    </div>
                    <div class="form-floating mb-3 position-relative">
                        <input type="password" class="form-control password-input" id="serviceNumber" name="serviceNumber" th:field="*{serviceNumber}" placeholder="ServiceNumber" autocomplete="off">
                        <label for="serviceNumber">ServiceNumber</label>
                        <span class="toggle-password" data-target="serviceNumber">
                            <i class="bi bi-eye"></i>
                        </span>
                        <div th:errors="*{serviceNumber}" class="text-danger"></div>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" type="submit">Сохранить данные</button>
                </div>
            </form>
        </div>
    </div>
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <h5 class="mb-3">Белпочта</h5>
        <p>Если у вас есть договор на API Белпочты, свяжитесь со мной для реализации интеграции.</p>
        <p class="fw-semibold">Контакт для связи:</p>
        <p>📧 <a href="mailto:info@belivery.by" class="text-decoration-none">info@belivery.by</a></p>
    </div>
</div>

<div class="tab-pane fade" id="v-pills-security" role="tabpanel" aria-labelledby="security-settings-link">
    <div class="card p-3 shadow-sm rounded-4 mb-4">
        <div id="password-content" th:fragment="passwordFragment">
            <h5 class="mb-3">Изменение пароля</h5>
            <form id="password-settings-form" th:action="@{/profile/settings/password}" th:object="${passwordChangeDTO}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-floating mb-3 position-relative">
                    <input type="password" class="form-control password-input" id="currentPassword" name="currentPassword" th:field="*{currentPassword}" placeholder="Текущий пароль" autocomplete="off">
                    <label for="currentPassword">Текущий пароль</label>
                    <span class="toggle-password" data-target="currentPassword">
                        <i class="bi bi-eye"></i>
                    </span>
                    <div th:errors="*{currentPassword}" class="text-danger"></div>
                </div>
                <div class="form-floating mb-3 position-relative">
                    <input type="password" class="form-control password-input" id="newPassword" name="newPassword" th:field="*{newPassword}" placeholder="Новый пароль" autocomplete="off">
                    <label for="newPassword">Новый пароль</label>
                    <span class="toggle-password" data-target="newPassword">
                        <i class="bi bi-eye"></i>
                    </span>
                    <div th:errors="*{newPassword}" class="text-danger"></div>
                </div>
                <div class="form-floating mb-3 position-relative">
                    <input type="password" class="form-control password-input" id="confirmPassword" name="confirmPassword" th:field="*{confirmPassword}" placeholder="Подтвердите пароль" autocomplete="off">
                    <label for="confirmPassword">Подтвердите пароль</label>
                    <span class="toggle-password" data-target="confirmPassword">
                        <i class="bi bi-eye"></i>
                    </span>
                    <div th:errors="*{confirmPassword}" class="text-danger"></div>
                </div>
                <div th:if="${notification}" class="mb-3">
                    <p th:text="${notification}" class="text-success"></p>
                </div>
                <button class="btn btn-primary w-100 py-2" type="submit">Изменить пароль</button>
            </form>
        </div>
    </div>
    <div class="card p-4 shadow-sm rounded-4">
        <h5 class="mb-3">Удаление аккаунта</h5>
        <p class="fw-semibold"><strong>Вы уверены, что хотите удалить аккаунт?</strong></p>
        <ul>
            <li>Вся ваша информация будет <strong>безвозвратно удалена</strong>, включая:
                <ul>
                    <li>Историю отслеживания посылок</li>
                    <li>Все загруженные файлы и данные</li>
                    <li>Настройки профиля и персональные данные</li>
                </ul>
            </li>
        </ul>
        <p>
            <strong>Удаление аккаунта необратимо</strong> – вы не сможете восстановить доступ.
            Если в будущем вы захотите снова воспользоваться сервисом, вам потребуется
            <strong>создать новый аккаунт с нуля</strong>.
        </p>
        <p>
            <strong>Обратите внимание:</strong>
            Если ваш аккаунт имел <strong>дополнительные платные функции или подписки</strong>,
            они также будут <strong>аннулированы без возможности восстановления</strong>.
        </p>
        <p class="text-uppercase fw-bold">Это действие невозможно отменить.</p>
        <button class="btn btn-danger w-50 py-2" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            <i class="bi bi-trash"></i> Удалить аккаунт
        </button>
    </div>
</div>
                </div>
            </div>
        </div>
    </div>
</main>

<th:block th:fragment="telegramStoreBlock(store, first)" th:remove="tag">
    <div th:id="'store-block-' + ${store.id}" class="mt-3 border p-3 rounded bg-light-subtle">
        <div th:if="${storeIdWithError == store.id}" class="alert alert-danger py-2" th:text="${templateError}"></div>

        <!-- Заголовок + управление ботом -->
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <h5 class="mb-1" th:text="${store.name}">Название магазина</h5>

                <div class="mb-1">
                    <div class="bot-selector">
                        <input type="radio"
                               th:id="'tg-bot-system-' + ${store.id}"
                               th:name="'tg-bot-type-' + ${store.id}"
                               value="system"
                               th:checked="${store.telegramSettings?.botToken == null}">
                        <label th:for="'tg-bot-system-' + ${store.id}">Системный бот</label>

                        <input type="radio"
                               th:id="'tg-bot-custom-' + ${store.id}"
                               th:name="'tg-bot-type-' + ${store.id}"
                               value="custom"
                               th:checked="${store.telegramSettings?.botToken != null}"
                               th:disabled="${!planDetails.allowCustomBot}"
                               th:attr="data-bs-toggle=${!planDetails.allowCustomBot} ? 'tooltip' : null,
                                    title=${!planDetails.allowCustomBot} ? 'Доступно в тарифе \'Бизнес\' и выше' : null">
                              <label th:for="'tg-bot-custom-' + ${store.id}" th:id="'tg-custom-bot-label-' + ${store.id}">
                                  <span th:text="${store.telegramSettings?.botUsername != null ? '@' + store.telegramSettings.botUsername : 'Собственный бот'}"></span>
                              </label>
                    </div>
                    <!-- Форма токена кастомного бота (показывается по JS при необходимости) -->
                    <div th:id="'tg-custom-bot-fields-' + ${store.id}" class="mb-2 ms-4 hidden custom-bot-fields" th:if="${planDetails.allowCustomBot}">
                        <label class="form-label" th:for="'tg-token-' + ${store.id}">Токен собственного бота</label>
                        <input type="text" class="form-control form-control-sm" th:id="'tg-token-' + ${store.id}"
                               name="botToken" th:value="${store.telegramSettings?.botToken}">
                        <p class="form-text current-bot" th:if="${store.telegramSettings?.botUsername}">
                            Текущий бот: <span th:text="${store.telegramSettings.botUsername}"></span>
                        </p>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                    th:id="'tg-save-bot-' + ${store.id}">Сохранить</button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    th:id="'tg-delete-bot-' + ${store.id}">Удалить</button>
                        </div>
                    </div>
                </div>

                <p class="form-text text-danger mb-1" th:unless="${planDetails.allowCustomBot}">
                    Функция собственного бота доступна в тарифе "Бизнес" и выше
                </p>
            </div>

            <button type="button" class="btn btn-sm btn-outline-secondary toggle-tg-btn"
                    th:attr="data-store-id=${store.id}">
                <i class="bi bi-chevron-up"></i>
            </button>
        </div>

        <!-- Основной блок настроек -->
        <div th:id="'collapse-tg-' + ${store.id}"
             class="tg-settings-content"
             th:attr="data-store-id=${store.id}"
             th:classappend="${first} ? ' expanded' : ' collapsed'">

            <form class="telegram-settings-form" th:action="@{/stores/{id}/telegram-settings(id=${store.id})}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" th:id="'tg-enable-' + ${store.id}" name="enabled"
                           th:checked="${store.telegramSettings != null and store.telegramSettings.enabled}"
                           th:disabled="${!planDetails.allowTelegramNotifications or !userSettingsDTO.telegramNotificationsEnabled}">
                    <label class="form-check-label" th:for="'tg-enable-' + ${store.id}">
                        Отправлять уведомления покупателям этого магазина
                    </label>
                </div>
                <p class="form-text ms-4">
                    Получатель увидит основные статусы посылки: «отправлена», «прибыла», «получена» и др.
                </p>

                <div th:id="'tg-reminders-block-' + ${store.id}"
                     class="form-check form-switch mb-2 ms-3 hidden reminders-container">
                    <input class="form-check-input" type="checkbox" th:id="'tg-reminders-' + ${store.id}"
                           name="remindersEnabled"
                           th:checked="${store.telegramSettings?.remindersEnabled}"
                           th:disabled="${!planDetails.allowTelegramNotifications or !userSettingsDTO.telegramNotificationsEnabled}">
                    <label class="form-check-label" th:for="'tg-reminders-' + ${store.id}">
                        Отправлять напоминания, если посылка не забрана
                    </label>
                </div>

                <div th:id="'tg-reminder-fields-' + ${store.id}" class="ms-4 hidden reminder-fields">
                    <div class="mb-2">
                        <label class="form-label" th:for="'tg-start-' + ${store.id}">
                            Через сколько дней после прибытия посылки отправить первое напоминание
                        </label>
                        <input type="number" class="form-control form-control-sm" th:id="'tg-start-' + ${store.id}"
                               name="reminderStartAfterDays"
                               th:value="${store.telegramSettings?.reminderStartAfterDays ?: 3}" min="1" max="14">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" th:for="'tg-repeat-' + ${store.id}">
                            Как часто повторять напоминания, если посылка не забрана (в днях)
                        </label>
                        <input type="number" class="form-control form-control-sm" th:id="'tg-repeat-' + ${store.id}"
                               name="reminderRepeatIntervalDays"
                               th:value="${store.telegramSettings?.reminderRepeatIntervalDays ?: 2}" min="1" max="14">
                    </div>
                    <div class="mb-2">
    <label class="form-label" th:for="'tg-remind-tpl-' + ${store.id}">Текст напоминания</label>
    <textarea class="form-control form-control-sm"
              th:id="'tg-remind-tpl-' + ${store.id}"
              name="reminderTemplate" rows="3"
              th:text="${store.telegramSettings?.reminderTemplate}"></textarea>

    <!-- Если используется системный бот (нет botToken) -->
    <p th:if="${store.telegramSettings == null or store.telegramSettings.botToken == null}"
       class="form-text text-muted">
        Шаблон должен содержать: {track} и {store}
    </p>

    <!-- Если кастомный бот -->
    <p th:if="${store.telegramSettings?.botToken != null}"
       class="form-text text-muted">
        Шаблон должен содержать: {track}
    </p>

    <!-- Пример уведомления -->
    <p th:if="${#strings.isEmpty(store.telegramSettings?.reminderTemplate)}"
       class="form-text">
        Пример уведомления: "🔔 Не забудьте забрать посылку {track} из магазина {store} — она ждёт вас."
    </p>
</div>

                </div>

                <div class="mb-2">
                    <label class="form-label" th:for="'tg-sign-' + ${store.id}">
                        Подпись к уведомлениям (отображается во всех сообщениях)
                    </label>
                    <input type="text" class="form-control form-control-sm" th:id="'tg-sign-' + ${store.id}"
                           name="customSignature"
                           th:value="${store.telegramSettings?.customSignature}" maxlength="200">
                </div>


                <div class="form-check form-switch mb-2 ms-3">
                    <input class="form-check-input" type="checkbox" th:id="'tg-custom-templates-' + ${store.id}"
                           name="useCustomTemplates"
                           th:checked="${store.telegramSettings?.templates?.size() > 0}"
                           th:disabled="${!planDetails.allowCustomNotifications}"
                           th:attr="data-bs-toggle=${!planDetails.allowCustomNotifications} ? 'tooltip' : null,
                                    title=${!planDetails.allowCustomNotifications} ? 'Доступно в тарифе \'Бизнес\' и выше' : null">
                    <label class="form-check-label" th:for="'tg-custom-templates-' + ${store.id}">
                        Использовать собственные сообщения
                    </label>
                </div>

                <div th:id="'tg-custom-template-fields-' + ${store.id}" class="ms-4 hidden custom-template-fields" th:if="${planDetails.allowCustomNotifications}">
                    <div th:each="status : ${T(com.project.tracking_system.entity.BuyerStatus).values()}">
                        <div class="mb-2">
                            <label class="form-label" th:for="${'tpl-' + status.name() + '-' + store.id}" th:text="${status.displayName}"></label>
                            <textarea class="form-control form-control-sm"
                                      th:id="${'tpl-' + status.name() + '-' + store.id}"
                                      th:name="${'templates[' + status.name() + ']'}"
                                      rows="3"
                                      th:text="${store.telegramSettings?.templates?.get(status.name())}"></textarea>
                        </div>
                    </div>
                    <!-- Если системный бот -->
<p th:if="${store.telegramSettings == null or store.telegramSettings.botToken == null}"
   class="form-text text-muted">
    Шаблон должен содержать: {track} и {store}
</p>

<!-- Если кастомный бот -->
<p th:if="${store.telegramSettings?.botToken != null}"
   class="form-text text-muted">
    Шаблон должен содержать: {track}
</p>
                </div>

                <p class="form-text text-danger mb-1" th:unless="${planDetails.allowCustomNotifications}">
                    Функция собственных уведомлений доступна в тарифе "Бизнес" и выше
                </p>

                <button type="submit" class="btn btn-sm btn-primary w-100">Сохранить</button>
            </form>
        </div>
    </div>
</th:block>


<div layout:fragment="afterFooter">
    <!-- Модальное окно подтверждения удаления аккаунта -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header position-relative">
                    <h5 class="modal-title text-danger w-100 text-center position-absolute start-50 translate-middle-x"
                        id="deleteAccountModalLabel">
                        Подтверждение удаления
                    </h5>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"
                            aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger fw-semibold text-center">
                        Вы уверены, что хотите удалить аккаунт? Это действие <span class="fw-bold text-uppercase">невозможно</span>
                        отменить.
                    </p>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form th:action="@{/profile/settings/delete}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-danger">
                            <i class="bi bi-trash-fill"></i> Да, удалить
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления магазина-->
    <div class="modal fade" id="deleteStoreModal" tabindex="-1" aria-labelledby="deleteStoreModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger fw-semibold text-center">
                        Вы уверены, что хотите <span class="fw-bold">удалить этот магазин</span>?
                        Это действие <span class="fw-bold text-uppercase">невозможно</span> отменить.
                    </p>
                    <p class="text-muted text-center">
                        ❗ Вместе с магазином будут удалены <br>
                        <span class="fw-semibold">все его посылки и аналитика</span>.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button class="btn btn-danger" id="confirmDeleteStore">Да, удалить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения очистки аналитики -->
    <div class="modal fade" id="resetAnalyticsModal" tabindex="-1" aria-labelledby="resetAnalyticsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="resetAnalyticsModalLabel">Подтверждение действия</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="resetAnalyticsMessage"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button class="btn btn-danger" id="confirmResetAnalytics">Да, удалить</button>
                </div>
            </div>
        </div>
    </div>

</div>

</html>
